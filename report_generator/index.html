<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Event Report Generator - CommunityHub</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Custom styles to match your theme */
        body {
            background-color: #0d1117; /* A deep navy/charcoal background */
            color: #c9d1d9; /* Light gray text for readability */
        }
        .card {
            background-color: #161b22; /* Slightly lighter card background */
            border: 1px solid #30363d;
            border-radius: 8px;
        }
        .input-field {
            background-color: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
        }
        .btn-primary {
            background-color: #238636; /* A nice green for primary actions */
            color: white;
            font-weight: 600;
            border-radius: 6px;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #2ea043;
        }
        .btn-primary:disabled {
            background-color: #23863655;
            cursor: not-allowed;
        }
        .upload-card.success {
             border-color: #238636;
        }
         .upload-card.error {
             border-color: #da3633;
        }
        /* Style for the rendered markdown report */
        .markdown-body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            line-height: 1.6;
        }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 {
            border-bottom: 1px solid #30363d;
            padding-bottom: 0.3em;
            margin-top: 24px;
            margin-bottom: 16px;
            font-weight: 600;
        }
        .markdown-body h1 { font-size: 2em; }
        .markdown-body h2 { font-size: 1.5em; }
        .markdown-body h3 { font-size: 1.25em; }
        .markdown-body ul { list-style-type: disc; padding-left: 2em; }
        .markdown-body li { margin-bottom: 0.5em; }
        .markdown-body code {
            background-color: #2d333b;
            padding: 0.2em 0.4em;
            margin: 0;
            font-size: 85%;
            border-radius: 6px;
        }
        .markdown-body blockquote {
            padding: 0 1em;
            color: #8b949e;
            border-left: 0.25em solid #30363d;
        }
        .markdown-body img {
            max-width: 100%;
            border-radius: 6px;
            margin-top: 1em;
            margin-bottom: 1em;
        }
    </style>
</head>
<body>
    <!-- Header Navigation (Mirrors your existing UI) -->
    <header class="bg-[#161b22] border-b border-[#30363d]">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="text-2xl font-bold">CommunityHub</div>
            <div>
                <a href="#" class="px-4 hover:text-white">Communities</a>
                <a href="#" class="px-4 hover:text-white">Events</a>
            </div>
            <div>
                <a href="#" class="px-3 py-2 border border-[#30363d] rounded-md hover:bg-[#21262d]">Log In</a>
                <a href="#" class="ml-2 px-3 py-2 bg-white text-black rounded-md font-semibold">Sign Up</a>
            </div>
        </nav>
    </header>

    <!-- Main Content Area -->
    <main class="container mx-auto p-6 md:p-12">
        <div class="max-w-4xl mx-auto">

            <!-- Page Header -->
            <div class="text-center mb-12">
                <h1 class="text-4xl font-bold text-white">AI Event Report Generator</h1>
                <p class="mt-4 text-lg text-[#8b949e]">Upload your event data to generate a comprehensive, AI-powered analysis.</p>
            </div>

            <!-- Report Generation Form -->
            <div id="report-form">
                <!-- Step 1: Event Details -->
                <div class="card p-8 mb-8">
                    <h2 class="text-2xl font-semibold mb-6 text-white"><i class="fa-solid fa-pen-to-square mr-3"></i>Step 1: Configure Your Report</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="event_name" class="block mb-2 font-medium">Event Name</label>
                            <input type="text" id="event_name" class="input-field w-full p-2.5" placeholder="e.g., TechFest 2025" required>
                        </div>
                        <div>
                            <label for="event_type" class="block mb-2 font-medium">Event Type</label>
                            <input type="text" id="event_type" class="input-field w-full p-2.5" placeholder="e.g., AI/ML Workshop Series" required>
                        </div>
                    </div>
                    <div class="mt-6">
                        <label for="institution_name" class="block mb-2 font-medium">Institution / Department</label>
                        <input type="text" id="institution_name" class="input-field w-full p-2.5" placeholder="e.g., Department of Computer Science" required>
                    </div>
                </div>

                <!-- Step 2: Upload Files -->
                <div class="card p-8 mb-8">
                    <h2 class="text-2xl font-semibold mb-6 text-white"><i class="fa-solid fa-file-arrow-up mr-3"></i>Step 2: Upload Your Data</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Attendee File Upload -->
                        <div id="upload-attendees" class="upload-card p-4 border-2 border-dashed border-[#30363d] rounded-lg text-center">
                            <h3 class="font-semibold text-white">Participant Data</h3>
                            <p class="text-sm text-[#8b949e] mb-2">attendees.csv <span class="font-bold text-red-400">(Required)</span></p>
                            <input type="file" id="attendees_file" class="hidden" accept=".csv">
                            <button onclick="document.getElementById('attendees_file').click()" class="w-full p-4 rounded-md bg-[#21262d] hover:bg-[#30363d]">
                                <i class="fa-solid fa-upload mr-2"></i>
                                <span id="attendees-status">Click to upload</span>
                            </button>
                        </div>
                        
                        <!-- Feedback File Upload -->
                         <div id="upload-feedback" class="upload-card p-4 border-2 border-dashed border-[#30363d] rounded-lg text-center">
                            <h3 class="font-semibold text-white">Feedback Data</h3>
                            <p class="text-sm text-[#8b949e] mb-2">feedback.csv <span class="font-bold text-red-400">(Required)</span></p>
                            <input type="file" id="feedback_file" class="hidden" accept=".csv">
                            <button onclick="document.getElementById('feedback_file').click()" class="w-full p-4 rounded-md bg-[#21262d] hover:bg-[#30363d]">
                                <i class="fa-solid fa-upload mr-2"></i>
                                <span id="feedback-status">Click to upload</span>
                            </button>
                        </div>

                        <!-- Crowd Analytics File Upload -->
                        <div id="upload-crowd" class="upload-card p-4 border-2 border-dashed border-[#30363d] rounded-lg text-center">
                            <h3 class="font-semibold text-white">Crowd Analytics</h3>
                            <p class="text-sm text-[#8b949e] mb-2">crowd_analytics.json <span class="text-yellow-400">(Optional)</span></p>
                            <input type="file" id="crowd_file" class="hidden" accept=".json">
                            <button onclick="document.getElementById('crowd_file').click()" class="w-full p-4 rounded-md bg-[#21262d] hover:bg-[#30363d]">
                                <i class="fa-solid fa-upload mr-2"></i>
                                <span id="crowd-status">Click to upload</span>
                            </button>
                        </div>

                        <!-- Social Mentions File Upload -->
                         <div id="upload-social" class="upload-card p-4 border-2 border-dashed border-[#30363d] rounded-lg text-center">
                            <h3 class="font-semibold text-white">Social Media Mentions</h3>
                            <p class="text-sm text-[#8b949e] mb-2">social_mentions.json <span class="text-yellow-400">(Optional)</span></p>
                            <input type="file" id="social_file" class="hidden" accept=".json">
                            <button onclick="document.getElementById('social_file').click()" class="w-full p-4 rounded-md bg-[#21262d] hover:bg-[#30363d]">
                                <i class="fa-solid fa-upload mr-2"></i>
                                <span id="social-status">Click to upload</span>
                            </button>
                        </div>
                    </div>
                </div>

                 <!-- Step 3: Generate Report Button -->
                <div class="text-center">
                    <button id="generate-btn" class="btn-primary px-12 py-4 text-lg" disabled>
                        <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Generate Report
                    </button>
                     <p id="error-message" class="text-red-400 mt-4 h-4"></p>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading-state" class="hidden text-center card p-8">
                 <i class="fa-solid fa-spinner fa-spin text-4xl mb-4"></i>
                 <h2 class="text-2xl font-semibold text-white">Generating Your Report...</h2>
                 <p class="text-[#8b949e]">The AI is analyzing the data. This may take a moment.</p>
            </div>

            <!-- Results Section -->
            <div id="results-section" class="hidden">
                 <div class="text-center mb-8">
                     <h2 class="text-3xl font-bold text-white">Your Report is Ready!</h2>
                     <p class="text-[#8b949e]">Review the AI-generated analysis for the <span id="result-event-name" class="font-bold text-white"></span> event.</p>
                 </div>
                 <div class="card p-8">
                     <div class="flex justify-end mb-4 space-x-4">
                        <a id="download-md-btn" href="#" class="px-4 py-2 border border-[#30363d] rounded-md hover:bg-[#21262d]">
                            <i class="fa-solid fa-file-code mr-2"></i>Download .md
                        </a>
                        <a id="download-pdf-btn" href="#" class="btn-primary px-4 py-2">
                            <i class="fa-solid fa-file-pdf mr-2"></i>Download .pdf
                        </a>
                     </div>
                     <div id="report-content" class="markdown-body">
                         <!-- The generated markdown report will be rendered here -->
                     </div>
                 </div>
                 <div class="text-center mt-8">
                     <button onclick="window.location.reload()" class="px-8 py-3 border border-[#30363d] rounded-md hover:bg-[#21262d]">
                         <i class="fa-solid fa-plus mr-2"></i>Generate Another Report
                     </button>
                 </div>
            </div>

        </div>
    </main>

<script>
    // This is a mock-up of the front-end logic.
    // You would integrate this with your actual API calls.

    const fileInputs = {
        'attendees.csv': document.getElementById('attendees_file'),
        'feedback.csv': document.getElementById('feedback_file'),
        'crowd_analytics.json': document.getElementById('crowd_file'),
        'social_mentions.json': document.getElementById('social_file'),
    };

    const statusLabels = {
        'attendees.csv': document.getElementById('attendees-status'),
        'feedback.csv': document.getElementById('feedback-status'),
        'crowd_analytics.json': document.getElementById('crowd-status'),
        'social_mentions.json': document.getElementById('social-status'),
    };
    
    const uploadCards = {
        'attendees.csv': document.getElementById('upload-attendees'),
        'feedback.csv': document.getElementById('upload-feedback'),
        'crowd_analytics.json': document.getElementById('upload-crowd'),
        'social_mentions.json': document.getElementById('upload-social'),
    }

    const requiredFiles = ['attendees.csv', 'feedback.csv'];
    const uploadedFiles = new Set();
    const generateBtn = document.getElementById('generate-btn');
    const errorMessage = document.getElementById('error-message');

    // Handle file uploads
    Object.keys(fileInputs).forEach(fileName => {
        const input = fileInputs[fileName];
        const fileType = fileName.split('.').pop(); // 'csv' or 'json'

        input.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            // Simple frontend validation for file type
            if (!file.name.toLowerCase().endsWith(fileType)) {
                 alert(`Invalid file type. Please upload a .${fileType} file.`);
                 return;
            }

            const statusLabel = statusLabels[fileName];
            const card = uploadCards[fileName];

            statusLabel.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i>Uploading...`;
            card.classList.remove('error', 'success');
            
            // --- API Call to Upload File ---
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                // The endpoint is /upload/{file_type} where file_type is the full filename
                const response = await fetch(`http://127.0.0.1:8000/upload/${fileName}`, {
                    method: 'POST',
                    body: formData,
                });

                if (response.ok) {
                    statusLabel.innerHTML = `<i class="fa-solid fa-check-circle mr-2"></i>${file.name}`;
                    card.classList.add('success');
                    uploadedFiles.add(fileName);
                    checkFormCompletion();
                } else {
                    const errorData = await response.json();
                    statusLabel.innerText = 'Upload Failed!';
                    card.classList.add('error');
                    errorMessage.innerText = errorData.detail || 'An unknown error occurred.';
                    uploadedFiles.delete(fileName);
                }
            } catch (error) {
                statusLabel.innerText = 'Upload Failed!';
                card.classList.add('error');
                errorMessage.innerText = 'Could not connect to the server.';
                console.error('Upload Error:', error);
                uploadedFiles.delete(fileName);
            }
             checkFormCompletion();
        });
    });

    // Check if all required files are uploaded to enable the button
    function checkFormCompletion() {
        const allRequiredUploaded = requiredFiles.every(file => uploadedFiles.has(file));
        generateBtn.disabled = !allRequiredUploaded;
    }

    // Handle report generation
    generateBtn.addEventListener('click', async () => {
        // Clear previous errors
        errorMessage.innerText = '';

        // 1. Get event details from form
        const eventDetails = {
            event_name: document.getElementById('event_name').value,
            event_type: document.getElementById('event_type').value,
            institution_name: document.getElementById('institution_name').value,
        };
        
        // Basic validation
        if (!eventDetails.event_name || !eventDetails.event_type || !eventDetails.institution_name) {
            errorMessage.innerText = 'Please fill in all event details.';
            return;
        }

        // 2. Switch to loading view
        document.getElementById('report-form').classList.add('hidden');
        document.getElementById('loading-state').classList.remove('hidden');

        // 3. --- API Call to Generate Report ---
        try {
            const response = await fetch('http://127.0.0.1:8000/generate-report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(eventDetails),
            });

            const result = await response.json();

            if (response.ok) {
                // 4. Display results
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('results-section').classList.remove('hidden');

                // Using a library like 'marked' would be better for production
                // For this example, we'll do some basic replacements
                let reportHtml = result.content
                    .replace(/# (.*)/g, '<h1>$1</h1>')
                    .replace(/## (.*)/g, '<h2>$1</h2>')
                    .replace(/### (.*)/g, '<h3>$1</h3>')
                    .replace(/\* \*\*(.*)\*\*/g, '<li><strong>$1</strong></li>')
                    .replace(/-\s\*\*(.*)\*\*:/g, '<li><strong>$1:</strong></li>')
                    .replace(/-\s(?!-)(.*)/g, '<li>$1</li>')
                    .replace(/\!\[(.*)\]\((.*)\)/g, '<img src="http://127.0.0.1:8000/static/output/$2" alt="$1">') // Important: Fix image paths
                    .replace(/\n/g, '<br>');


                document.getElementById('report-content').innerHTML = reportHtml;
                document.getElementById('result-event-name').innerText = eventDetails.event_name;
                
                // --- MODIFICATION: Set up both download links ---
                const uniqueReportFilename = result.report_filename || 'event_report.md';

                // 1) .md download (in-memory blob)
                const mdBlob = new Blob([result.content], { type: 'text/markdown' });
                const mdUrl = URL.createObjectURL(mdBlob);
                const mdBtn = document.getElementById('download-md-btn');
                mdBtn.href = mdUrl;
                mdBtn.download = uniqueReportFilename;

                // 2) PDF download - request backend conversion endpoint
                const pdfBtn = document.getElementById('download-pdf-btn');
                // Ensure the host matches your backend (use 127.0.0.1 for local)
                pdfBtn.href = `http://127.0.0.1:8000/download-report/pdf?filename=${encodeURIComponent(uniqueReportFilename)}`;
                pdfBtn.target = "_blank";

            } else {
                 throw new Error(result.detail || 'Failed to generate report.');
            }
        } catch (error) {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('report-form').classList.remove('hidden'); // Show form again
            errorMessage.innerText = `Error: ${error.message}`;
            console.error('Generation Error:', error);
        }
    });
</script>

</body>
</html>