<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Event Report Generator</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { background-color: #0d1117; color: #c9d1d9; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; }
        .card { background-color: #161b22; border: 1px solid #30363d; border-radius: 8px; }
        .input-field { background-color: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; width: 100%; padding: 0.5rem; }
        .btn-primary { background-color: #238636; color: white; font-weight: 600; border-radius: 6px; transition: background-color 0.3s; padding: 0.5rem 1rem; }
        .btn-primary:hover { background-color: #2ea043; }
        .btn-primary:disabled { background-color: #23863655; cursor: not-allowed; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9em; }
        .section-title { font-size: 1.25em; font-weight: 600; margin-bottom: 1rem; border-bottom: 1px solid #30363d; padding-bottom: 0.5rem; color: white; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-group { margin-bottom: 1rem; }
    </style>
</head>
<body>
    <header class="bg-[#161b22] border-b border-[#30363d] p-4">
        <div class="container mx-auto text-2xl font-bold">CommunityHub - Report Generator</div>
    </header>

    <main class="container mx-auto p-6 md:p-12 max-w-5xl">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">Event Report Form</h1>
            <p class="text-[#8b949e]">Fill in the details to generate your PDF report using the strict DBIT template.</p>
        </div>

        <div id="report-form" class="card p-8 shadow-lg">
            <!-- Event Meta -->
            <div class="mb-8">
                <h2 class="section-title">1. Event Metadata</h2>
                <div class="grid-2">
                    <div class="form-group"><label>Department Name</label><input type="text" id="department_name" class="input-field" placeholder="e.g. Department of Computer Engineering" value="Department of Computer Engineering"></div>
                    <div class="form-group"><label>Event Category / Type</label><input type="text" id="event_type" class="input-field" placeholder="e.g. National Level Technical Workshop" value="National Level Technical Workshop"></div>
                    <div class="form-group"><label>Event Title</label><input type="text" id="title" class="input-field" placeholder="Full Title of Event" value="Advanced AI Workshop"></div>
                    <div class="form-group"><label>Date</label><input type="text" id="date" class="input-field" placeholder="DD Month YYYY" value="15 January 2026"></div>
                    <div class="form-group"><label>Time</label><input type="text" id="time" class="input-field" placeholder="Start - End" value="10:00 AM to 4:00 PM"></div>
                    <div class="form-group"><label>Venue</label><input type="text" id="venue" class="input-field" placeholder="Location" value="Seminar Hall 1"></div>
                </div>
            </div>

            <!-- Participants -->
            <div class="mb-8">
                <h2 class="section-title">2. Participants & Registration</h2>
                <div class="grid-2">
                    <div class="form-group"><label>Target Audience</label><input type="text" id="target_audience" class="input-field" placeholder="e.g. FE/COMP/IT" value="FE/COMP/IT"></div>
                    <div class="form-group"><label>Total Participants</label><input type="number" id="total_participants" class="input-field" value="120"></div>
                    <div class="form-group"><label>Girls</label><input type="number" id="girl_participants" class="input-field" value="45"></div>
                    <div class="form-group"><label>Boys</label><input type="number" id="boy_participants" class="input-field" value="75"></div>
                    <div class="form-group"><label>DBIT Students</label><input type="number" id="dbit_students" class="input-field" value="110"></div>
                    <div class="form-group"><label>Non-DBIT Students</label><input type="number" id="non_dbit_students" class="input-field" value="10"></div>
                </div>
            </div>

            <!-- Organizers -->
            <div class="mb-8">
                <h2 class="section-title">3. Organizers & Signatories</h2>
                <div class="grid-2">
                    <div class="form-group"><label>Resource Person</label><input type="text" id="resource_person" class="input-field" value="Dr. John Doe"></div>
                    <div class="form-group"><label>Resource Person Org</label><input type="text" id="resource_org" class="input-field" value="IIT Bombay"></div>
                    <div class="form-group"><label>Organizing Body</label><input type="text" id="organizing_body" class="input-field" value="CSI Student Chapter"></div>
                    <div class="form-group"><label>Faculty Coordinator</label><input type="text" id="faculty_coordinator" class="input-field" value="Prof. Jane Doe"></div>
                    <div class="form-group"><label>Prepared By (Name)</label><input type="text" id="prepared_name" class="input-field" value="Nathan Pimenta"></div>
                    <div class="form-group"><label>Prepared By (Post)</label><input type="text" id="prepared_post" class="input-field" value="Technical Head"></div>
                    <div class="form-group"><label>Approved By (Name)</label><input type="text" id="approved_name" class="input-field" value="Dr. Alice Brown"></div>
                    <div class="form-group"><label>Approved By (Post)</label><input type="text" id="approved_post" class="input-field" value="Head of Department"></div>
                </div>
            </div>

            <!-- Content -->
            <div class="mb-8">
                <h2 class="section-title">4. Content & Analysis</h2>
                <div class="form-group"><label>Objectives (One per line)</label><textarea id="objectives" class="input-field" rows="3">To provide foundational knowledge.&#10;To introduce practical implementations.</textarea></div>
                <div class="form-group"><label>Outcomes (One per line)</label><textarea id="outcomes" class="input-field" rows="3">Participants gained clarity on concepts.&#10;Students understood strategies.</textarea></div>
                <div class="form-group"><label>Detailed Report Paragraphs</label><textarea id="detailed_report" class="input-field" rows="5">The workshop commenced at 10:00 AM.</textarea></div>
                <div class="form-group"><label>Snapshot Description</label><textarea id="snapshot_description" class="input-field" rows="2">Candid interactions during the event.</textarea></div>
                <div class="form-group"><label>Feedback Summary</label><textarea id="feedback_text" class="input-field" rows="2">Feedback was excellent. 92% rated highly.</textarea></div>
            </div>

            <!-- Social Media URLs -->
            <div class="mb-8">
                <h2 class="section-title">5. Social Media</h2>
                <div class="grid-2">
                    <div class="form-group"><label>Facebook URL</label><input type="url" id="facebook" class="input-field"></div>
                    <div class="form-group"><label>Instagram URL</label><input type="url" id="instagram" class="input-field"></div>
                    <div class="form-group"><label>LinkedIn URL</label><input type="url" id="linkedin" class="input-field"></div>
                </div>
            </div>

            <!-- Files -->
            <div class="mb-8">
                <h2 class="section-title">6. Images & Data (Optional Uploads)</h2>
                <div class="grid-2">
                    <div class="form-group"><label>College Logo</label><input type="file" id="college_logo" class="input-field" accept="image/png, image/jpeg"></div>
                    <div class="form-group"><label>Club Logo</label><input type="file" id="club_logo" class="input-field" accept="image/png, image/jpeg"></div>
                    <div class="form-group"><label>Event Photo 1</label><input type="file" id="photo1" class="input-field" accept="image/png, image/jpeg"></div>
                    <div class="form-group"><label>Event Photo 2</label><input type="file" id="photo2" class="input-field" accept="image/png, image/jpeg"></div>
                    <div class="form-group"><label>Feedback Chart</label><input type="file" id="feedback_image" class="input-field" accept="image/png, image/jpeg"></div>
                    <div class="form-group"><label>Event Poster</label><input type="file" id="poster_image" class="input-field" accept="image/png, image/jpeg"></div>
                    <div class="form-group"><label>Attendees Data (CSV with Name, Branch)</label><input type="file" id="attendees_csv" class="input-field" accept=".csv"></div>
                </div>
            </div>

            <div class="text-center mt-6">
                <button id="generate-btn" class="btn-primary w-full text-lg py-3"><i class="fa-solid fa-file-pdf mr-2"></i>Compile PDF Report</button>
                <p id="status-msg" class="mt-4 text-[#8b949e]"></p>
                <a id="download-link" href="#" target="_blank" class="hidden text-green-400 mt-2 block font-bold text-lg"><i class="fa-solid fa-download mr-1"></i> Download Generated PDF</a>
            </div>
        </div>
    </main>

    <script>
        let API_BASE = (typeof location !== 'undefined') ? `${location.protocol}//${location.host}` : 'http://127.0.0.1:8003';

        async function uploadFile(fileInput, filename) {
            if (!fileInput.files.length) return;
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            await fetch(`${API_BASE}/upload/${filename}`, { method: 'POST', body: formData });
        }

        document.getElementById('generate-btn').addEventListener('click', async () => {
            const btn = document.getElementById('generate-btn');
            const status = document.getElementById('status-msg');
            const downloadLink = document.getElementById('download-link');
            
            btn.disabled = true;
            status.innerText = 'Uploading files (if any)...';
            status.className = 'mt-4 text-yellow-400';
            downloadLink.classList.add('hidden');

            try {
                // Upload files
                await uploadFile(document.getElementById('college_logo'), 'college_logo.png');
                await uploadFile(document.getElementById('club_logo'), 'club_logo.png');
                await uploadFile(document.getElementById('photo1'), 'photo1.png');
                await uploadFile(document.getElementById('photo2'), 'photo2.png');
                await uploadFile(document.getElementById('feedback_image'), 'feedback_image.png');
                await uploadFile(document.getElementById('poster_image'), 'poster_image.png');
                await uploadFile(document.getElementById('attendees_csv'), 'attendees.csv');

                status.innerText = 'Compiling LaTeX... This can take 5-10 seconds.';
                
                // Build JSON Payload
                const getVal = id => document.getElementById(id).value;
                const getList = id => getVal(id).split('\n').map(l => l.trim()).filter(l => l);

                const payload = {
                    "institute": {},
                    "event_meta": {
                        "department_name": getVal('department_name'),
                        "event_type": getVal('event_type'),
                        "title": getVal('title'),
                        "date": getVal('date'),
                        "time": getVal('time'),
                        "venue": getVal('venue')
                    },
                    "participants": {
                        "target_audience": getVal('target_audience'),
                        "total_participants": parseInt(getVal('total_participants')) || 0,
                        "girl_participants": parseInt(getVal('girl_participants')) || 0,
                        "boy_participants": parseInt(getVal('boy_participants')) || 0
                    },
                    "organizers": {
                        "resource_person": getVal('resource_person'),
                        "resource_org": getVal('resource_org'),
                        "organizing_body": getVal('organizing_body'),
                        "faculty_coordinator": getVal('faculty_coordinator')
                    },
                    "content": {
                        "objectives": getList('objectives'),
                        "outcomes": getList('outcomes'),
                        "detailed_report": getVal('detailed_report'),
                        "snapshot_description": getVal('snapshot_description')
                    },
                    "feedback": {
                        "feedback_text": getVal('feedback_text')
                    },
                    "social_media": {
                        "facebook": getVal('facebook'),
                        "instagram": getVal('instagram'),
                        "linkedin": getVal('linkedin')
                    },
                    "registration": {
                        "dbit_students": parseInt(getVal('dbit_students')) || 0,
                        "non_dbit_students": parseInt(getVal('non_dbit_students')) || 0
                    },
                    "signatories": {
                        "prepared_name": getVal('prepared_name'),
                        "prepared_post": getVal('prepared_post'),
                        "approved_name": getVal('approved_name'),
                        "approved_post": getVal('approved_post')
                    }
                };

                const response = await fetch(`${API_BASE}/generate-report`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok) {
                    status.innerText = '✅ Report generated successfully!';
                    status.className = 'mt-4 text-green-400';
                    downloadLink.href = API_BASE + result.pdf_url;
                    downloadLink.classList.remove('hidden');
                } else {
                    status.innerText = '❌ Error: ' + (result.detail || 'Failed');
                    status.className = 'mt-4 text-red-400';
                }

            } catch (err) {
                status.innerText = '❌ Request failed: ' + err.message;
                status.className = 'mt-4 text-red-400';
            } finally {
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>